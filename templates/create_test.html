{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title mb-0">Create New Test</h2>
            </div>
            <div class="card-body">
                <form id="createTestForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Battery Bank Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>

                    <div class="mb-3">
                        <label for="job_number" class="form-label">Job Number</label>
                        <input type="text" class="form-control" id="job_number" name="job_number" required>
                    </div>

                    <div class="mb-3">
                        <label for="customer_name" class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                    </div>

                    <div class="mb-3">
                        <label for="cell_type" class="form-label">Cell Type</label>
                        <select class="form-select" id="cell_type" name="cell_type" required>
                            <option value="">Select Cell Type</option>
                            <option value="KPL">KPL</option>
                            <option value="KPM">KPM</option>
                            <option value="KPH">KPH</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="cell_rate" class="form-label">Cell Rate</label>
                        <input type="number" step="0.01" class="form-control" id="cell_rate" name="cell_rate" required>
                    </div>

                    <div class="mb-3">
                        <label for="percentage_capacity" class="form-label">Percentage Capacity</label>
                        <input type="number" step="0.01" class="form-control" id="percentage_capacity" name="percentage_capacity" required>
                    </div>

                    <div class="mb-3">
                        <label for="discharge_current" class="form-label">Discharge Current</label>
                        <input type="number" step="0.01" class="form-control" id="discharge_current" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="num_cells" class="form-label">Number of Cells</label>
                        <input type="number" class="form-control" id="num_cells" name="num_cells" min="1" required>
                    </div>

                    <div class="mb-3">
                        <label for="total_cycles" class="form-label">Total Cycles</label>
                        <input type="number" class="form-control" id="total_cycles" name="total_cycles" min="1" required>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Create Test</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function calculateDischargeCurrent() {
        const cellRate = parseFloat(document.getElementById('cell_rate').value) || 0;
        const percentageCapacity = parseFloat(document.getElementById('percentage_capacity').value) || 0;
        const dischargeCurrent = (cellRate * percentageCapacity / 100).toFixed(2);
        document.getElementById('discharge_current').value = dischargeCurrent;
    }

    document.getElementById('cell_rate').addEventListener('input', calculateDischargeCurrent);
    document.getElementById('percentage_capacity').addEventListener('input', calculateDischargeCurrent);

    document.getElementById('createTestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        formData.append('discharge_current', document.getElementById('discharge_current').value);

        try {
            const response = await fetch('/create_test', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                window.location.href = `/test/${data.test_id}/readings`;
            }
        } catch (error) {
            console.error('Error creating test:', error);
            alert('Failed to create test. Please try again.');
        }
    });
});
</script>
{% endblock %}